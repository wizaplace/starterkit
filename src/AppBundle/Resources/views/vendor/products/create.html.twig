{% extends '@App/layout-vendor.html.twig' %}

{% block profile_content %}
    <form id="create-product-form" method="POST" action="{{ path('vendor_products_create') }}" enctype="multipart/form-data">
        <div class="form-group row">
            <div class="col-4">
                <label for="name" class="required">{{ 'vendor.products.creation.name'|trans }}</label>
                <input type="text" class="form-control mb-2 mr-sm-2" id="name" name="product_name" required>
            </div>
            <div class="col-4">
                <label for="code" class="required">{{ 'vendor.products.creation.code'|trans }}</label>
                <input type="text" class="form-control mb-2 mr-sm-2" id="code" name="code" required>
            </div>
            <div class="col-4">
                <label for="supplier_reference">{{ 'vendor.products.creation.supplier_reference'|trans }}</label>
                <input type="text" class="form-control mb-2 mr-sm-2" id="supplier_reference" name="supplier_reference">
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="price" class="required">{{ 'vendor.products.creation.price'|trans }}</label>
                <input type="number" step="0.01" class="form-control mb-2 mr-sm-2" id="price" name="price" value="0" required>
            </div>
            <div class="col-6">
                <label for="quantity" class="required">{{ 'vendor.products.creation.quantity'|trans }}</label>
                <input type="number" step="1" class="form-control mb-2 mr-sm-2" id="quantity" name="quantity" value="1" required>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="status" class="required">{{ 'vendor.products.creation.status.title'|trans }}</label>
                <select class="form-control" id="status" name="status" required>
                    <option selected>{{ 'vendor.products.creation.status.select'|trans }}</option>
                    <option v-for="status in statusList" :value="status.value" v-text="status.name"></option>
                </select>
            </div>
            <div class="col-6">
                <label for="main_category" class="required">{{ 'vendor.products.creation.main_category.title'|trans }}</label>
                <select class="form-control" id="main_category" name="main_category" required>
                    <option selected>{{ 'vendor.products.creation.main_category.select'|trans }}</option>
                    <option v-for="category in categoriesList" :value="category.value" v-text="category.name"></option>
                </select>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="green_tax" class="required">{{ 'vendor.products.creation.green_tax'|trans }}</label>
                <input type="number" step="0.01" class="form-control mb-2 mr-sm-2" id="green_tax" name="green_tax" value="0" required>
            </div>
            <div class="col-6">
                <label for="tax_ids" class="required">{{ 'vendor.products.creation.tax_ids.title'|trans }}</label>
                <select class="form-control" id="tax_ids" name="tax_ids" required>
                    <option selected>{{ 'vendor.products.creation.tax_ids.select'|trans }}</option>
                    <option v-for="tax in taxesList" :value="tax.value" v-text="tax.name"></option>
                </select>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-4">
                <div class="form-check text-center">
                    <input class="form-check-input" type="checkbox" id="is_brand_new" name="is_brand_new" checked>
                    <label class="form-check-label" for="is_brand_new">{{ 'vendor.products.creation.is_brand_new'|trans }}</label>
                </div>
            </div>
            <div class="col-4">
                <div class="form-check text-center">
                    <input class="form-check-input" type="checkbox" id="has_free_shipping" name="has_free_shipping">
                    <label class="form-check-label" for="has_free_shipping">{{ 'vendor.products.creation.has_free_shipping'|trans }}</label>
                </div>
            </div>
            <div class="col-4">
                <div class="form-check text-center">
                    <input class="form-check-input" type="checkbox" id="is_downloadable" name="is_downloadable">
                    <label class="form-check-label" for="is_downloadable">{{ 'vendor.products.creation.is_downloadable'|trans }}</label>
                </div>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="weight">{{ 'vendor.products.creation.weight'|trans }}</label>
                <input type="number" step="0.001" class="form-control mb-2 mr-sm-2" id="weight" name="weight" value="0">
            </div>
            <div class="col-6">
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="full_description">{{ 'vendor.products.creation.full_description'|trans }}</label>
                <textarea class="form-control mb-2 mr-sm-2" id="full_description" name="full_description"></textarea>
            </div>
            <div class="col-6">
                <label for="short_description">{{ 'vendor.products.creation.short_description'|trans }}</label>
                <textarea class="form-control mb-2 mr-sm-2" id="short_description" name="short_description"></textarea>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-6">
                <label for="availability_date">{{ 'vendor.products.creation.availability_date'|trans }}</label>
                <input type="text" class="form-control mb-2 mr-sm-2" id="availability_date" name="availability_date">
            </div>
        </div>

        {# geolocation #}
        <div id="js-geolocation" class="form-group row">
            <div class="col-12">
                <label for="geolocationAddress">{{ 'vendor.products.creation.geolocation.address'|trans }}</label>
                <input id="geolocationAddress" type="text" class="form-control" name="geolocationAddress" autocomplete="nope" required> {# https://developer.mozilla.org/en-US/docs/Web/Security/Securing_your_site/Turning_off_form_autocompletion #}
            </div>

            <input id="geolocationLatitude" type="hidden" name="latitude" value="">
            <input id="geolocationLongitude" type="hidden" name="longitude" value="">
            <input id="geolocationLabel" type="hidden" name="label" value="">
            <input id="geolocationZipcode" type="hidden" name="zipcode" value="">
        </div>

        <div class="form-group row">
            <div class="col-12">
                <h3>{{ 'vendor.products.creation.free_attributes.title'|trans }}</h3>
                <button type="button" class="btn btn-secondary mb-2" @click="addFreeAttributeFields()">{{ 'vendor.products.creation.free_attributes.add'|trans }}</button>
                <div id="free-attributes">
                    <div class="form-group row" v-for="i in freeAttributesCount">
                        <div class="col-5">
                            <label :for="'free_attributes['+i+'][key]'">{{ 'vendor.products.creation.free_attributes.name'|trans }}</label>
                            <input type="text" class="form-control mb-2 mr-sm-2" :id="'free_attributes['+i+'][key]'" :name="'free_attributes['+i+'][key]'">
                        </div>
                        <div class="col-5">
                            <label :for="'free_attributes['+i+'][value]'">{{ 'vendor.products.creation.free_attributes.value'|trans }}</label>
                            <input type="text" class="form-control mb-2 mr-sm-2" :id="'free_attributes['+i+'][value]'" :name="'free_attributes['+i+'][value]'">
                        </div>
                        <div class="col-2">
                            <button type="button" @click="removeFreeAttributeFields(i)" class="btn btn-danger">x</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-12">
                <label for="main_image">{{ 'vendor.products.creation.main_image'|trans }}</label>
                <input type="file" class="form-control mb-2 mr-sm-2" id="main_image" name="main_image">
            </div>
        </div>
        <div class="form-group row">
            <div class="col-12">
                <h3>{{ 'vendor.products.creation.additional_images.title'|trans }}</h3>
                <button type="button" class="btn btn-secondary mb-2" @click="addAdditionalImageField()">{{ 'vendor.products.creation.additional_images.add'|trans }}</button>
                <div id="additional-images">
                    <div class="form-group row" v-for="i in additionalImagesCount">
                        <div class="col-10">
                            <label :for="'additional_images['+i+']'">{{ 'vendor.products.creation.additional_images.title'|trans }}</label>
                            <input type="file" class="form-control mb-2 mr-sm-2" :id="'additional_images['+i+']'" :name="'additional_images['+i+']'" @change="updateMainImageHasContent()">
                        </div>
                        <div class="col-2">
                            <button type="button" @click="removeAdditionalImageField(i)" class="btn btn-danger">x</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if bof_attachments_enabled %}
            <div class="form-group row mb-5">
                <div class="col-12">
                    <h3>{{ 'vendor.products.creation.attachments.title'|trans }}</h3>
                    <button type="button" class="btn btn-secondary mb-2" @click="addAttachmentFields()">{{ 'vendor.products.creation.attachments.add'|trans }}</button>
                    <div id="attachments">
                        <div class="form-group row" v-for="i in attachmentsCount">
                            <div class="col-5">
                                <label :for="'attachments['+i+'][key]'">{{ 'vendor.products.creation.attachments.label'|trans }}</label>
                                <input type="text" class="form-control mb-2 mr-sm-2" :id="'attachments['+i+'][key]'" :name="'attachments['+i+'][key]'">
                            </div>
                            <div class="col-5">
                                <label :for="'attachments['+i+'][value]'">{{ 'vendor.products.creation.attachments.value'|trans }}</label>
                                <input type="text" class="form-control mb-2 mr-sm-2" :id="'attachments['+i+'][value]'" :name="'attachments['+i+'][value]'">
                            </div>
                            <div class="col-2">
                                <button type="button" @click="removeAttachmentFields(i)" class="btn btn-danger">x</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ 'vendor.products.creation.submit'|trans }}</button>
    </form>
{% endblock %}

{% block scripts %}
    <script>
        $(function(){
            $('#availability_date').datepicker();

            new Vue({
                el: '#create-product-form',
                data: {
                    statusList: {{ productStatusList|json_encode|raw }},
                    categoriesList: {{ categoriesList|json_encode|raw }},
                    taxesList: {{ taxList|json_encode|raw }},
                    freeAttributesCount: 0,
                    additionalImagesCount: 0,
                    attachmentsCount: 0,
                    mainImageHasContent: false,
                    displayAdditionalImagesFields: 'hidden',
                    formList: [
                        {
                            id: 'geolocation',
                            title: '{{ 'vendor.products.creation.geolocation.title'|trans }}',
                            type: 'object',
                            multiple: false,
                            required: false,
                            object: [
                                {
                                    id: 'latitude',
                                    inputName: 'latitude',
                                    name: '{{ 'vendor.products.creation.geolocation.latitude'|trans }}',
                                    type: 'number',
                                    step: null,
                                    required: false,
                                },
                                {
                                    id: 'longitude',
                                    inputName: 'longitude',
                                    name: '{{ 'vendor.products.creation.geolocation.longitude'|trans }}',
                                    type: 'number',
                                    step: null,
                                    required: false,
                                },
                                {
                                    id: 'label',
                                    inputName: 'label',
                                    name: '{{ 'vendor.products.creation.geolocation.label'|trans }}',
                                    type: 'text',
                                    required: false,
                                },
                                {
                                    id: 'zipcode',
                                    inputName: 'zipcode',
                                    name: '{{ 'vendor.products.creation.geolocation.zipcode'|trans }}',
                                    type: 'text',
                                    required: false,
                                },
                            ],
                        },
                        {
                            id: 'affiliate_link',
                            inputName: 'affiliate_link',
                            name: '{{ 'vendor.products.creation.affiliate_link'|trans }}',
                            type: 'conditional', // @TODO: Modifier cette partie quand on en saura plus sur
                                                 // les conditions d'affichage
                            value: 'disabled',
                            required: false,
                        },
                        {
                            id: 'declinations',
                            inputName: 'declinations',
                            name: '{{ 'vendor.products.creation.declinations'|trans }}',
                            type: 'conditional', // @TODO: Modifier cette partie quand on en saura plus sur
                                                 // les conditions d'affichage
                            value: 'disabled',
                            required: false,
                        },
                    ],
                    googleMapsAutocomplete: null
                },
                methods: {
                    addFreeAttributeFields() {
                        this.freeAttributesCount++;
                    },
                    removeFreeAttributeFields(number) {
                        var freeAttributes = document.getElementById('free_attributes['+number+'][key]');
                        $(freeAttributes).closest('.form-group').remove();
                    },
                    addAdditionalImageField() {
                        this.additionalImagesCount++;
                    },
                    removeAdditionalImageField(number) {
                        var additionalImages = document.getElementById('additional_images['+number+']');
                        $(additionalImages).closest('.form-group').remove();
                    },
                    addAttachmentFields() {
                        this.attachmentsCount++;
                    },
                    removeAttachmentFields(number) {
                        var attachments = document.getElementById('attachments['+number+'][key]');
                        $(attachments).closest('.form-group').remove();
                    },

                    initGooglePlace: function () {
                        var labelInput = document.getElementById('geolocationAddress');
                        this.googleMapsAutocomplete = new google.maps.places.Autocomplete(labelInput);
                        this.googleMapsAutocomplete.addListener('place_changed', this.geolocAutocompleted);
                    },

                    geolocAutocompleted: function () {
                        var place = this.googleMapsAutocomplete.getPlace();

                        {# l'utilisateur a entré un lieu non existant ou la requête a échouée #}
                        if (! place.geometry) return;

                        {# récupère les informations de geolocalisation #}
                        var latitude = place.geometry.location.lat();
                        var longitude = place.geometry.location.lng();
                        var label = place.formatted_address;
                        var zipcode = "";

                        {# récupère le code postal s'il existe #}
                        place.address_components.forEach(function (component) {
                            if (_.includes(component.types, "postal_code")) {
                                zipcode = component.long_name;
                            }
                        });

                        {# complète les valeurs des champs cachés du formulaire #}
                        $("#geolocationLatitude").val(latitude);
                        $("#geolocationLongitude").val(longitude);
                        $("#geolocationLabel").val(label);
                        $("#geolocationZipcode").val(zipcode);
                    }
                },
                mounted: function () {
                    this.initGooglePlace();
                }
            });
        });
    </script>
{% endblock %}
