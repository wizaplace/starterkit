{% extends '@App/layout.html.twig' %}

{% block meta %}
    <link rel="canonical" href="{{ product|productUrl }}">
{% endblock %}

{% block body %}
    {% set declination = product.declinations.0 %}
    {% set inStock = declination.amount > 0 %}

    <section id="product-page">
        <div class="container">

            {# breadcrumb #}
            {% include '@App/common/breadcrumb.html.twig' with {'categoryPath': product.categoryPath } %}

            {# badge 'new' #}
            {% if product.creationDate.timestamp > date('-7days', 'Europe/Paris').timestamp %}
                <div class="badge">{{ 'new'|trans }}</div><br>
            {% endif %}

            {# product name #}
            <h1>{{ product.name }}</h1>

            {# product short description #}
            <p>{{ product.shortDescription|striptags|raw }}</p>

            {# product's vendor #}
            <p>{{ 'sold_by'|trans }}&nbsp;:&nbsp;{{ product.companies[0].name }}</p>

            {# open 'contact vendor' modal #}
            <p><a data-toggle="modal" href="#discussion-modal">{{ 'contact_vendor'|trans }}</a></p>

            <hr>

            {# product image #}
            {% if declination.images %}
                {% include '@App/common/product/image-gallery.html.twig' with {'images': declination.images } %}
            {% else %}
                <img src="{{ asset('images/no-image.jpg') }}">
            {% endif %}

            <hr>

            {# product long description #}
            <p>{{ 'supplier_reference'|trans }}&nbsp;:&nbsp;{{ product.supplierReference }}</p>
            <p>{{ 'ean_code'|trans }}&nbsp;:&nbsp;{{ product.code }}</p>
            <p>{{ 'in_stock'|trans|capitalize }}&nbsp;:&nbsp;
                {% if inStock %}
                    {{ 'in_stock'|trans }}
                {% else %}
                    {{ 'out_of_stock'|trans }}
                {% endif %}
            </p>

            <hr>

            {# price - if product has promo #}
            {% if declination.crossedoutprice %}
                <div>{{ 'crossedoutprice_new'|trans({'%price%': declination.pricewithoutvat|price }) }}</div>
                <div class="badge">{{ 'crossedoutprice_promo'|trans|upper }}</div>
                <div>{{ 'crossedoutprice_original'|trans({'%price%': declination.crossedoutprice|price }) }}</div>

            {# price - without promo #}
            {% else %}
                <div>{{ 'crossedoutprice_new'|trans({'%price%': declination.priceWithoutVat|price }) }}</div>
            {% endif %}

            {# including greentax #}
            <div>{{ 'greentax'|trans({'%tax%': declination.greenTax|price }) }}</div>

            <hr>

            {# options selector #}
            {% if options %}
                <h3>{{ 'options'|trans }} :</h3>

                <ul>
                    {% for option in options  %}
                        <li class="option-name">{{ option.name }}
                            <select title={{ 'select'|trans }} data-id="{{ option.id }}" onchange="updateDeclination(this)">
                                {% for variant in option.variants %}
                                    <option value="{{ variant.id }}" data-url="{{ variant.url }}" {% if variant.selected %}selected{% endif %}>{{ variant.name }}</option>
                                {% endfor %}
                            </select>
                        </li>
                    {% endfor %}
                </ul>

                <hr>
            {% endif %}

            {# add to basket #}
            <h3>{{ 'quantity'|trans }}</h3>
            <div class="quantity-widget">
                <input type="number" :value="quantity" v-model="quantity" {% if not inStock %} disabled {% endif %}>
                <button class="btn btn-default" type="button" @click="decreaseQuantity" {% if not inStock %} disabled {% endif %}> - </button>
                <button class="btn btn-default" type="button" @click="increaseQuantity" {% if not inStock %} disabled {% endif %}> + </button>

                {% if inStock %}
                    <button class="btn btn-primary" type="button" @click="submitBasket">{{ 'add_to_basket'|trans }}</button>
                {% else %}
                    <button class="btn btn-primary" type="button" disabled>{{ 'out_of_stock'|trans }}</button>
                {% endif %}
            </div>

            <hr>

            {# product long description #}
            <h2>{{ 'product_description'|trans }}</h2>
            <p>{{ product.description|striptags('<br><p>')|raw }}</p>

            <hr>

            <h2>{{ 'technical_characteristics'|trans }}</h2>
            <table>
                {% for attribute in product.attributes %}
                    <tr>
                        <td>{{ attribute.name }}</td>
                        <td>
                            {% for value in attribute.value %}
                                {{ value }}
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </table>

            <hr>

            {# customer reviews #}
            <h2>{{ 'customers_reviews'|trans }}</h2>
            {% for review in reviews if reviews|length > 0 %}

                {# customer name #}
                <span>{{ review.author.name }}</span>

                {# rating #}
                {% for i in 1..5 %}
                    {% if i <= review.rating %}
                        <i class="glyphicon glyphicon-star"></i>
                    {% else %}
                        <i class="glyphicon glyphicon-star-empty"></i>
                    {% endif %}
                {% endfor %}

                {# review message #}
                <p>{{ review.message |capitalize }}</p>
                <span>{{ review.postedAt|date('d/m/Y') }}</span>

                <hr>
            {% endfor %}

            {# 'add your own review' #}
            <div class="add-review">
                <h2>{{ 'add_a_comment'|trans }}</h2>

                {# user is logged in #}
                {% if app.user %}
                    <form method="post" action="{{ path('create_product_review') }}">
                        <input type="hidden" name="redirect_url" value="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="author" value="{{ app.user.wizaplaceUser.firstName~' '~app.user.wizaplaceUser.lastName }}">

                        {# star rating #}
                        <label for="review-rate" class="">{{ 'your_rating'|trans }}&nbsp;:</label>
                        <input id="review-rate" name="rating" class="js-rating form-control hide" value="3">

                        {# message input #}
                        <label for="review-message">{{ 'your_message'|trans }}&nbsp;:</label>
                        <textarea id="review-message" name="message" class="form-control" rows="5" cols="72"></textarea>

                        {# review submit button #}
                        <input type="submit" class="btn btn-primary" name="dispatch[discussion.add]" value="{{ 'send'|trans|upper }}">
                    </form>

                {# user is not looged in #}
                {% else %}
                    <a href="{{ path('login') }}">{{ 'login_to_comment'|trans }}</a>
                {% endif %}
            </div>
        </div>

        <hr>

        {% include '@App/common/product/showcase.html.twig' with {'headerTitle': 'Autres "Bornes Wifi', "products" : latestProducts } %}
        {% include '@App/common/product/showcase.html.twig' with {'headerTitle': 'Accéssoires "Réseaux', "products" : latestProducts } %}

        {# modals #}
        {% include '@App/common/basket-popup.html.twig' %}
        {% include '@App/product/_discussion-modal.html.twig' %}

    </section>
{% endblock %}

{% block script %}
    <script>
        $(function() {

            new Vue({
                delimiters: ['${','}'],
                el: '#product-page',
                data: {
                    productId: {{ product.id }},
                    quantity: 1,
                },

                methods: {
                    increaseQuantity: function() {
                        if(this.quantity < {{ product.declinations.0.amount|e('js') }}) {
                            this.quantity ++;
                        }
                    },

                    decreaseQuantity: function() {
                        if(this.quantity > 1) {
                            this.quantity --;
                        }
                    },

                    submitBasket: function() {
                        var quantity = this.quantity;
                        $.ajax({
                            type: "POST",
                            url: "{{ path('basket_add_product') }}",
                            data: { declinationId: this.productId, quantity: quantity },
                            success: function(response) {
                                var declinationInfo = {
                                    name: {{ product.name|json_encode|raw }},
                                    price: {{ declination.priceWithoutVat|json_encode|raw }},
                                    image: {{ (declination.images|length > 0) ? declination.images|first|imageUrl(100, 100)|json_encode|raw : 'null' }},
                                };
                                hydrateModal(declinationInfo, quantity, response.message);
                            }
                        });
                    }
                },
            });

            $('.slider-for').slick({
                slidesToShow: 1,
                slidesToScroll: 1,
                arrows: false,
                fade: true,
                asNavFor: '.slider-nav'
            });

            $('.slider-nav').slick({
                slidesToShow: 3,
                slidesToScroll: 3,
                asNavFor: '.slider-for',
                infinite: true,
                dots: true,
                centerMode: true,
                focusOnSelect: true,
                arrows: false
            });
        });

        function updateDeclination(select){
            window.location.replace($(select).find(':selected').data('url'));
        }
    </script>
{% endblock %}
